<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yo! Lokalmedien - Marktanalyse Dashboard (Datenverbunden)</title>
    
    <!-- External Libraries -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary-color: #2563eb;
            --secondary-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --success-color: #065f46;
            --success-light: #84cc16;
            --dark: #1f2937;
            --light: #f3f4f6;
            --border: #e5e7eb;
            --bg-primary: #ffffff;
            --bg-secondary: #f9fafb;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
        }
        
        [data-theme="dark"] {
            --bg-primary: #1f2937;
            --bg-secondary: #111827;
            --text-primary: #f3f4f6;
            --text-secondary: #9ca3af;
            --border: #374151;
            --light: #374151;
            --dark: #f3f4f6;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.6;
            transition: background 0.3s, color 0.3s;
        }
        
        .header {
            background: var(--bg-primary);
            border-bottom: 2px solid var(--border);
            padding: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        @media (min-width: 768px) {
            .logo {
                font-size: 2rem;
            }
        }
        
        .header-stats {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
        }
        
        .header-controls {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        @media (max-width: 640px) {
            .header-controls {
                width: 100%;
                justify-content: center;
            }
            
            .header-controls .btn {
                flex: 1;
                min-width: auto;
                font-size: 0.875rem;
                padding: 0.5rem 0.75rem;
            }
        }
        
        .theme-toggle {
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            padding: 0.5rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s;
        }
        
        .theme-toggle:hover {
            background: var(--primary-color);
            color: white;
        }
        
        .stat-card {
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        @media (min-width: 768px) {
            .stat-value {
                font-size: 1.5rem;
            }
            .stat-label {
                font-size: 0.875rem;
            }
        }
        
        .nav-tabs {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border);
            overflow-x: auto;
        }
        
        .nav-tabs-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            gap: 0.5rem;
            padding: 0 1rem;
            min-width: max-content;
        }
        
        .nav-tab {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.3s;
            white-space: nowrap;
            font-size: 0.875rem;
        }
        
        @media (min-width: 768px) {
            .nav-tab {
                padding: 1rem 1.5rem;
                font-size: 1rem;
            }
        }
        
        .nav-tab:hover {
            color: var(--primary-color);
        }
        
        .nav-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
        }
        
        @media (min-width: 768px) {
            .container {
                padding: 2rem;
            }
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .filter-panel {
            background: var(--bg-primary);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        @media (min-width: 768px) {
            .filter-panel {
                padding: 1.5rem;
            }
        }
        
        .filter-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        @media (min-width: 768px) {
            .filter-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (min-width: 1024px) {
            .filter-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        .filter-group label {
            display: block;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
            color: var(--text-secondary);
        }
        
        .filter-group input,
        .filter-group select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 0.875rem;
        }
        
        .filter-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            font-size: 0.875rem;
        }
        
        .btn-primary {
            background: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background: #1d4ed8;
        }
        
        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover {
            background: var(--light);
        }
        
        .btn-success {
            background: var(--secondary-color);
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .data-table {
            background: var(--bg-primary);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: var(--bg-secondary);
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
            border-bottom: 2px solid var(--border);
            cursor: pointer;
            user-select: none;
            font-size: 0.875rem;
        }
        
        th:hover {
            background: var(--light);
        }
        
        td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
            font-size: 0.875rem;
        }
        
        tbody tr:hover {
            background: var(--bg-secondary);
        }
        
        .score-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.75rem;
        }
        
        .score-high {
            background: #10b981;
            color: white;
        }
        
        .score-medium {
            background: #f59e0b;
            color: white;
        }
        
        .score-low {
            background: #ef4444;
            color: white;
        }
        
        .checkbox-cell {
            text-align: center;
        }
        
        #map {
            height: 500px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .segment-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        
        @media (min-width: 768px) {
            .segment-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (min-width: 1024px) {
            .segment-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        .segment-card {
            background: var(--bg-primary);
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .segment-card h3 {
            color: var(--primary-color);
            margin-bottom: 1rem;
            font-size: 1rem;
        }
        
        .city-list {
            list-style: none;
        }
        
        .city-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
            font-size: 0.875rem;
        }
        
        .city-list li:last-child {
            border-bottom: none;
        }
        
        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        
        @media (min-width: 768px) {
            .comparison-grid {
                grid-template-columns: 1fr 2fr 1fr;
            }
        }
        
        .comparison-card {
            background: var(--bg-primary);
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .comparison-card h4 {
            margin-bottom: 0.5rem;
        }
        
        .comparison-select {
            margin-bottom: 1rem;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: var(--bg-primary);
            padding: 2rem;
            border-radius: 8px;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            position: relative;
        }
        
        @media (min-width: 768px) {
            .modal-content {
                max-width: 600px;
            }
        }
        
        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
        }
        
        .modal-close:hover {
            color: var(--text-primary);
        }
        
        .loader {
            border: 3px solid var(--border);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            background: #fef2f2;
            color: #991b1b;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            border-left: 4px solid #ef4444;
        }
        
        [data-theme="dark"] .error-message {
            background: #7f1d1d;
            color: #fecaca;
        }
        
        .success-message {
            background: #f0fdf4;
            color: #14532d;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            border-left: 4px solid #10b981;
        }
        
        [data-theme="dark"] .success-message {
            background: #14532d;
            color: #bbf7d0;
        }
        
        .data-source-panel {
            background: var(--bg-primary);
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .data-source-panel h3 {
            color: var(--primary-color);
            margin-bottom: 1rem;
        }
        
        .source-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        
        @media (min-width: 768px) {
            .source-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (min-width: 1024px) {
            .source-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        .source-option {
            padding: 1rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .source-option:hover {
            border-color: var(--primary-color);
            background: var(--bg-secondary);
        }
        
        .source-option.active {
            border-color: var(--primary-color);
            background: rgba(37, 99, 235, 0.1);
        }
        
        .source-option h4 {
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }
        
        .source-option p {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .file-upload {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .file-upload:hover {
            border-color: var(--primary-color);
            background: var(--bg-secondary);
        }
        
        .file-upload.dragover {
            border-color: var(--primary-color);
            background: rgba(37, 99, 235, 0.1);
        }
        
        .file-upload input[type="file"] {
            display: none;
        }
        
        .weight-slider-group {
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        .weight-slider {
            width: 100%;
            height: 8px;
            -webkit-appearance: none;
            appearance: none;
            background: var(--border);
            border-radius: 4px;
            outline: none;
            transition: all 0.3s;
        }
        
        .weight-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--primary-color);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .weight-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--primary-color);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .weight-slider:hover::-webkit-slider-thumb {
            transform: scale(1.2);
        }
        
        .weight-slider:hover::-moz-range-thumb {
            transform: scale(1.2);
        }
        
        .weight-value {
            font-weight: bold;
            color: var(--primary-color);
            min-width: 50px;
            text-align: right;
        }
        
        .modal-tab {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: var(--text-secondary);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .modal-tab:hover {
            color: var(--primary-color);
        }
        
        .modal-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        
        .modal-tab-content {
            animation: fadeIn 0.3s;
        }
        
        .methodology-category {
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <h1 class="logo">Yo! Lokalmedien</h1>
            <div class="header-stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalCities">0</div>
                    <div class="stat-label">St√§dte analysiert</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgScore">0</div>
                    <div class="stat-label">‚åÄ Score</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="topCities">0</div>
                    <div class="stat-label">Top St√§dte (75+)</div>
                </div>
            </div>
            <div class="header-controls">
                <button class="theme-toggle" onclick="toggleTheme()" title="Theme wechseln">üåô</button>
                <button class="btn btn-primary" onclick="showMethodologyModal()" title="Bewertungsmethodik">‚öôÔ∏è Methodik</button>
            </div>
        </div>
    </header>
    
    <nav class="nav-tabs">
        <div class="nav-tabs-content">
            <div class="nav-tab active" onclick="switchTab('overview')">üìä √úbersicht</div>
            <div class="nav-tab" onclick="switchTab('map')">üó∫Ô∏è Karte</div>
            <div class="nav-tab" onclick="switchTab('segments')">üìà Segmentanalyse</div>
            <div class="nav-tab" onclick="switchTab('comparison')">‚öñÔ∏è St√§dtevergleich</div>
            <div class="nav-tab" onclick="switchTab('datasources')">üìä Datenquellen</div>
        </div>
    </nav>
    
    <div class="container">
        <!-- Overview Tab -->
        <div id="overview" class="tab-content active">
            <div class="filter-panel">
                <div class="filter-grid">
                    <div class="filter-group">
                        <label>Suche</label>
                        <input type="text" id="searchInput" placeholder="Stadt suchen..." onkeyup="filterTable()">
                    </div>
                    <div class="filter-group">
                        <label>Bundesland</label>
                        <select id="bundeslandFilter" onchange="filterTable()">
                            <option value="">Alle</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Min. Score</label>
                        <input type="number" id="minScoreFilter" min="0" max="100" placeholder="0" onchange="filterTable()">
                    </div>
                    <div class="filter-group">
                        <label>Verlag</label>
                        <select id="verlagFilter" onchange="filterTable()">
                            <option value="">Alle</option>
                            <option value="none">Ohne Gro√üverlag</option>
                            <option value="funke">Mit Funke</option>
                            <option value="ippen">Mit Ippen</option>
                            <option value="madsack">Mit Madsack</option>
                        </select>
                    </div>
                </div>
                <div class="filter-buttons">
                    <button class="btn btn-primary" onclick="filterTable()">üîç Filtern</button>
                    <button class="btn btn-secondary" onclick="resetFilters()">‚Ü∫ Zur√ºcksetzen</button>
                    <button class="btn btn-success" onclick="exportToExcel()">üì• Excel Export</button>
                </div>
            </div>
            
            <div class="data-table">
                <div class="table-container">
                    <table id="citiesTable">
                        <thead>
                            <tr>
                                <th onclick="sortTable('name')">Stadt ‚ÜïÔ∏è</th>
                                <th onclick="sortTable('bundesland')">Bundesland ‚ÜïÔ∏è</th>
                                <th onclick="sortTable('einwohner')">Einwohner ‚ÜïÔ∏è</th>
                                <th onclick="sortTable('kaufkraft')">Kaufkraft ‚ÜïÔ∏è</th>
                                <th onclick="sortTable('akademikerquote')">Akademiker % ‚ÜïÔ∏è</th>
                                <th onclick="sortTable('score')">Score ‚ÜïÔ∏è</th>
                                <th>Verlage</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="citiesTableBody">
                            <!-- Table rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Map Tab -->
        <div id="map-tab" class="tab-content">
            <div id="map"></div>
        </div>
        
        <!-- Segments Tab -->
        <div id="segments" class="tab-content">
            <div id="segmentGrid" class="segment-grid">
                <!-- Segment cards will be inserted here -->
            </div>
        </div>
        
        <!-- Comparison Tab -->
        <div id="comparison" class="tab-content">
            <div class="comparison-grid">
                <div class="comparison-card">
                    <h4>Stadt 1</h4>
                    <div class="comparison-select">
                        <select id="city1Select" class="filter-group">
                            <option value="">W√§hlen...</option>
                        </select>
                    </div>
                    <div id="city1Details"></div>
                </div>
                <div class="comparison-card">
                    <canvas id="comparisonChart"></canvas>
                </div>
                <div class="comparison-card">
                    <h4>Stadt 2</h4>
                    <div class="comparison-select">
                        <select id="city2Select" class="filter-group">
                            <option value="">W√§hlen...</option>
                        </select>
                    </div>
                    <div id="city2Details"></div>
                </div>
            </div>
        </div>
        
        <!-- Data Sources Tab -->
        <div id="datasources" class="tab-content">
            <div class="data-source-panel">
                <h3>üìä Verf√ºgbare Datenquellen</h3>
                <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                    Verbinden Sie das Dashboard mit externen Datenquellen f√ºr aktuelle Marktdaten. 
                    Gr√ºn markierte Quellen sind bereits verbunden und synchronisieren automatisch.
                </p>
                <div class="source-grid">
                    <div class="source-option" onclick="connectDataSource('destatis')">
                        <h4>üìä Statistisches Bundesamt</h4>
                        <p>Offizielle Bev√∂lkerungs- und Wirtschaftsdaten</p>
                        <small>Status: <span id="destatis-status" style="color: var(--success-color);">‚úì Verbunden</span></small>
                    </div>
                    <div class="source-option" onclick="connectDataSource('opendata')">
                        <h4>üóÉÔ∏è Open Data Portal</h4>
                        <p>St√§dte mit Open Data Initiativen</p>
                        <small>Status: <span id="opendata-status" style="color: var(--success-color);">‚úì Verbunden</span></small>
                    </div>
                    <div class="source-option" onclick="connectDataSource('gfk')">
                        <h4>üí∞ GfK Kaufkraftdaten</h4>
                        <p>Kaufkraftindex und Konsumpotenzial</p>
                        <small>Status: <span id="gfk-status" style="color: var(--warning-color);">‚ö†Ô∏è API-Key erforderlich</span></small>
                    </div>
                    <div class="source-option" onclick="connectDataSource('mediadb')">
                        <h4>üì∞ Mediendatenbank</h4>
                        <p>Lokalzeitungen und Verlage</p>
                        <small>Status: <span id="mediadb-status" style="color: var(--success-color);">‚úì Verbunden</span></small>
                    </div>
                    <div class="source-option" onclick="connectDataSource('osm')">
                        <h4>üó∫Ô∏è OpenStreetMap</h4>
                        <p>Geografische Daten und POIs</p>
                        <small>Status: <span id="osm-status" style="color: var(--success-color);">‚úì Verbunden</span></small>
                    </div>
                    <div class="source-option" onclick="connectDataSource('custom')">
                        <h4>üìÅ Eigene Daten</h4>
                        <p>CSV/Excel Upload</p>
                        <small>Status: <span id="custom-status" style="color: var(--text-secondary);">Nicht verbunden</span></small>
                    </div>
                </div>
            </div>
            
            <div class="data-source-panel">
                <h3>üì§ Datenimport</h3>
                <div class="file-upload" onclick="document.getElementById('fileInput').click()" 
                     ondrop="dropHandler(event);" ondragover="dragOverHandler(event);" 
                     ondragleave="dragLeaveHandler(event);">
                    <p>üìÅ CSV oder Excel Datei hierher ziehen</p>
                    <p style="margin-top: 0.5rem;">oder klicken zum Ausw√§hlen</p>
                    <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" onchange="handleFileSelect(event)">
                </div>
                <div id="importStatus"></div>
            </div>
            
            <div class="data-source-panel">
                <h3>‚öôÔ∏è API Konfiguration</h3>
                <div style="display: grid; gap: 1rem;">
                    <div class="filter-group">
                        <label>GfK API-Key</label>
                        <input type="password" id="gfkApiKey" placeholder="API-Key eingeben">
                    </div>
                    <div class="filter-group">
                        <label>Update-Intervall</label>
                        <select id="updateInterval">
                            <option value="manual">Manuell</option>
                            <option value="daily">T√§glich</option>
                            <option value="weekly">W√∂chentlich</option>
                            <option value="monthly">Monatlich</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="saveApiConfig()">üíæ Konfiguration speichern</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- City Details Modal -->
    <div id="cityModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal()">√ó</span>
            <h2 id="modalTitle"></h2>
            <div id="modalBody"></div>
        </div>
    </div>
    
    <!-- Methodology Modal -->
    <div id="methodologyModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <span class="modal-close" onclick="closeMethodologyModal()">√ó</span>
            <h2>‚öôÔ∏è Bewertungsmethodik</h2>
            
            <!-- Tab Navigation -->
            <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem; border-bottom: 2px solid var(--border); padding-bottom: 0;">
                <button class="modal-tab active" onclick="switchModalTab('explanation')" id="tab-explanation">
                    üìñ Erl√§uterungen
                </button>
                <button class="modal-tab" onclick="switchModalTab('weights')" id="tab-weights">
                    ‚öñÔ∏è Gewichtung anpassen
                </button>
            </div>
            
            <div id="methodologyModalBody">
                <!-- Explanation Tab -->
                <div id="explanation-content" class="modal-tab-content active">
                    <div style="margin-bottom: 1.5rem;">
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                            Die Bewertung der St√§dte erfolgt anhand von sechs gleichgewichteten Kategorien mit jeweils maximal 25 Punkten. 
                            Der Gesamtscore (max. 100 Punkte) identifiziert optimale Expansionsm√§rkte f√ºr lokale Medienangebote.
                        </p>
                    </div>
                    
                    <div style="display: grid; gap: 1rem;">
                        <div class="methodology-category">
                            <h4 style="color: var(--primary-color); margin-bottom: 0.5rem;">üì∞ Medienwettbewerb (max. 25 Punkte)</h4>
                            <p style="margin-bottom: 0.5rem;">Bewertet die bestehende Medienlandschaft und Konkurrenzsituation:</p>
                            <ul style="margin-left: 1.5rem; color: var(--text-secondary); font-size: 0.875rem;">
                                <li>Anzahl und Reichweite lokaler Zeitungen</li>
                                <li>Pr√§senz gro√üer Verlagsh√§user (Funke, Ippen, Madsack)</li>
                                <li>Vielfalt der Medienangebote</li>
                                <li>Marktl√ºcken und Expansionspotenzial</li>
                            </ul>
                        </div>
                        
                        <div class="methodology-category">
                            <h4 style="color: var(--primary-color); margin-bottom: 0.5rem;">üë• Zielgruppe (max. 25 Punkte)</h4>
                            <p style="margin-bottom: 0.5rem;">Analysiert demografische und sozio√∂konomische Faktoren:</p>
                            <ul style="margin-left: 1.5rem; color: var(--text-secondary); font-size: 0.875rem;">
                                <li>Bev√∂lkerungsgr√∂√üe und -entwicklung</li>
                                <li>Altersstruktur und Bildungsniveau</li>
                                <li>Akademikerquote</li>
                                <li>Mediennutzungsverhalten</li>
                            </ul>
                        </div>
                        
                        <div class="methodology-category">
                            <h4 style="color: var(--primary-color); margin-bottom: 0.5rem;">üíª Digitale Affinit√§t (max. 25 Punkte)</h4>
                            <p style="margin-bottom: 0.5rem;">Misst die digitale Reife und Innovationsbereitschaft:</p>
                            <ul style="margin-left: 1.5rem; color: var(--text-secondary); font-size: 0.875rem;">
                                <li>Open Data Initiativen</li>
                                <li>Digitale Infrastruktur</li>
                                <li>Tech-Szene und Start-ups</li>
                                <li>E-Government Angebote</li>
                            </ul>
                        </div>
                        
                        <div class="methodology-category">
                            <h4 style="color: var(--primary-color); margin-bottom: 0.5rem;">üí∞ Wirtschaftskraft (max. 25 Punkte)</h4>
                            <p style="margin-bottom: 0.5rem;">Evaluiert √∂konomische Rahmenbedingungen:</p>
                            <ul style="margin-left: 1.5rem; color: var(--text-secondary); font-size: 0.875rem;">
                                <li>Kaufkraftindex</li>
                                <li>Wirtschaftswachstum</li>
                                <li>Arbeitslosenquote</li>
                                <li>Unternehmensstruktur</li>
                            </ul>
                        </div>
                        
                        <div class="methodology-category">
                            <h4 style="color: var(--primary-color); margin-bottom: 0.5rem;">üèõÔ∏è Lokale Identit√§t (max. 25 Punkte)</h4>
                            <p style="margin-bottom: 0.5rem;">Bewertet regionale Bindung und Gemeinschaftsgef√ºhl:</p>
                            <ul style="margin-left: 1.5rem; color: var(--text-secondary); font-size: 0.875rem;">
                                <li>Kulturelle Veranstaltungen</li>
                                <li>Vereinsleben und Traditionen</li>
                                <li>Regionale Besonderheiten</li>
                                <li>B√ºrgerbeteiligung</li>
                            </ul>
                        </div>
                        
                        <div class="methodology-category">
                            <h4 style="color: var(--primary-color); margin-bottom: 0.5rem;">üîß Praktikabilit√§t (max. 25 Punkte)</h4>
                            <p style="margin-bottom: 0.5rem;">Pr√ºft operative Umsetzbarkeit:</p>
                            <ul style="margin-left: 1.5rem; color: var(--text-secondary); font-size: 0.875rem;">
                                <li>Geografische Erreichbarkeit</li>
                                <li>Vorhandene Infrastruktur</li>
                                <li>Kooperationsm√∂glichkeiten</li>
                                <li>Markteintrittsbarrieren</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div style="margin-top: 2rem; padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                        <p style="margin: 0; color: var(--text-secondary);">
                            <strong>Score-Interpretation:</strong><br>
                            ‚Ä¢ 75-100 Punkte: Top-Opportunit√§t (gr√ºn)<br>
                            ‚Ä¢ 60-74 Punkte: Mittleres Potenzial (gelb)<br>
                            ‚Ä¢ &lt; 60 Punkte: Geringe Priorit√§t (rot)
                        </p>
                    </div>
                </div>
                
                <!-- Weights Tab -->
                <div id="weights-content" class="modal-tab-content" style="display: none;">
                    <div style="margin-bottom: 1.5rem;">
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                            Passen Sie die Gewichtung der einzelnen Kategorien f√ºr die Gesamtbewertung an. 
                            Die Summe aller Gewichte wird automatisch auf 100% normalisiert.
                        </p>
                    </div>
                    
                    <div id="weightSliders" style="display: grid; gap: 1.5rem;">
                        <!-- Medien -->
                        <div class="weight-slider-group">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <label style="font-weight: 600; color: var(--text-primary);">
                                    üì∞ Medienwettbewerb
                                </label>
                                <span class="weight-value" id="weight-medien-value">16.7%</span>
                            </div>
                            <input type="range" id="weight-medien" min="0" max="100" value="16.7" 
                                   class="weight-slider" oninput="updateWeights()">
                            <small style="color: var(--text-secondary);">Lokalzeitungen, Verlage, Medienvielfalt</small>
                        </div>
                        
                        <!-- Zielgruppe -->
                        <div class="weight-slider-group">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <label style="font-weight: 600; color: var(--text-primary);">
                                    üë• Zielgruppe
                                </label>
                                <span class="weight-value" id="weight-zielgruppe-value">16.7%</span>
                            </div>
                            <input type="range" id="weight-zielgruppe" min="0" max="100" value="16.7" 
                                   class="weight-slider" oninput="updateWeights()">
                            <small style="color: var(--text-secondary);">Demografie, Bildung, Kaufkraft</small>
                        </div>
                        
                        <!-- Digital -->
                        <div class="weight-slider-group">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <label style="font-weight: 600; color: var(--text-primary);">
                                    üíª Digitale Affinit√§t
                                </label>
                                <span class="weight-value" id="weight-digital-value">16.7%</span>
                            </div>
                            <input type="range" id="weight-digital" min="0" max="100" value="16.7" 
                                   class="weight-slider" oninput="updateWeights()">
                            <small style="color: var(--text-secondary);">Open Data, Tech-Szene, Digitalisierung</small>
                        </div>
                        
                        <!-- Wirtschaft -->
                        <div class="weight-slider-group">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <label style="font-weight: 600; color: var(--text-primary);">
                                    üí∞ Wirtschaftskraft
                                </label>
                                <span class="weight-value" id="weight-wirtschaft-value">16.7%</span>
                            </div>
                            <input type="range" id="weight-wirtschaft" min="0" max="100" value="16.7" 
                                   class="weight-slider" oninput="updateWeights()">
                            <small style="color: var(--text-secondary);">BIP, Arbeitsmarkt, Wirtschaftswachstum</small>
                        </div>
                        
                        <!-- Identit√§t -->
                        <div class="weight-slider-group">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <label style="font-weight: 600; color: var(--text-primary);">
                                    üèõÔ∏è Lokale Identit√§t
                                </label>
                                <span class="weight-value" id="weight-identitaet-value">16.7%</span>
                            </div>
                            <input type="range" id="weight-identitaet" min="0" max="100" value="16.7" 
                                   class="weight-slider" oninput="updateWeights()">
                            <small style="color: var(--text-secondary);">Kultur, Tradition, Gemeinschaftsgef√ºhl</small>
                        </div>
                        
                        <!-- Praktikabilit√§t -->
                        <div class="weight-slider-group">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <label style="font-weight: 600; color: var(--text-primary);">
                                    üîß Praktikabilit√§t
                                </label>
                                <span class="weight-value" id="weight-praktikabilitaet-value">16.7%</span>
                            </div>
                            <input type="range" id="weight-praktikabilitaet" min="0" max="100" value="16.7" 
                                   class="weight-slider" oninput="updateWeights()">
                            <small style="color: var(--text-secondary);">Erreichbarkeit, Infrastruktur, Umsetzbarkeit</small>
                        </div>
                    </div>
                    
                    <div style="margin-top: 2rem; padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 600;">Gesamtgewichtung:</span>
                            <span id="total-weight" style="font-weight: bold; color: var(--primary-color);">100%</span>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                        <button class="btn btn-secondary" onclick="resetWeights()">‚Ü∫ Zur√ºcksetzen</button>
                        <button class="btn btn-primary" onclick="applyWeights()">‚úì Anwenden</button>
                        <button class="btn btn-success" onclick="saveWeightPreset()">üíæ Als Vorlage speichern</button>
                    </div>
                    
                    <div style="margin-top: 2rem;">
                        <h4 style="margin-bottom: 1rem;">üìã Gespeicherte Vorlagen</h4>
                        <div id="weightPresets" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem;">
                            <button class="btn btn-secondary" onclick="loadPreset('balanced')">Ausgeglichen</button>
                            <button class="btn btn-secondary" onclick="loadPreset('media-focus')">Medienfokus</button>
                            <button class="btn btn-secondary" onclick="loadPreset('economic-focus')">Wirtschaftsfokus</button>
                            <button class="btn btn-secondary" onclick="loadPreset('digital-focus')">Digitalfokus</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Global variables
        let cities = [];
        let filteredCities = [];
        let map = null;
        let comparisonChart = null;
        let darkMode = false;
        let sortColumn = 'score';
        let sortDirection = 'desc';
        
        // Weight configuration
        let categoryWeights = {
            medien: 16.7,
            zielgruppe: 16.7,
            digital: 16.7,
            wirtschaft: 16.7,
            identitaet: 16.7,
            praktikabilitaet: 16.7
        };
        
        // Weight presets
        const weightPresets = {
            balanced: {
                medien: 16.7,
                zielgruppe: 16.7,
                digital: 16.7,
                wirtschaft: 16.7,
                identitaet: 16.7,
                praktikabilitaet: 16.7
            },
            'media-focus': {
                medien: 30,
                zielgruppe: 20,
                digital: 15,
                wirtschaft: 15,
                identitaet: 10,
                praktikabilitaet: 10
            },
            'economic-focus': {
                medien: 10,
                zielgruppe: 20,
                digital: 20,
                wirtschaft: 30,
                identitaet: 10,
                praktikabilitaet: 10
            },
            'digital-focus': {
                medien: 15,
                zielgruppe: 20,
                digital: 30,
                wirtschaft: 15,
                identitaet: 10,
                praktikabilitaet: 10
            }
        };
        
        // Data Source Configuration
        const dataSources = {
            destatis: {
                name: 'Statistisches Bundesamt',
                url: 'https://www-genesis.destatis.de/api',
                active: false,
                lastUpdate: null
            },
            opendata: {
                name: 'Open Data Portal',
                url: 'https://www.govdata.de/api',
                active: false,
                lastUpdate: null
            },
            gfk: {
                name: 'GfK Kaufkraft',
                url: 'https://api.gfk.com/kaufkraft',
                active: false,
                requiresAuth: true,
                lastUpdate: null
            },
            mediadb: {
                name: 'Mediendatenbank',
                url: 'internal',
                active: false,
                lastUpdate: null
            },
            osm: {
                name: 'OpenStreetMap',
                url: 'https://nominatim.openstreetmap.org/search',
                active: false,
                lastUpdate: null
            },
            custom: {
                name: 'Eigene Daten',
                active: false,
                lastUpdate: null
            }
        };
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadInitialData();
            loadSavedWeights();
            setupEventListeners();
            checkStoredTheme();
            loadDataSourceConfig();
        });
        
        // Load initial data (extended dataset)
        function loadInitialData() {
            // Extended city data with more realistic entries
            cities = [
                // Major cities
                { name: 'Berlin', bundesland: 'Berlin', einwohner: 3677472, kaufkraft: 23896, akademikerquote: 35.2, lokalzeitungen: 8, typ: 'Hauptstadt', openData: true, funke: true, ippen: false, madsack: false, lat: 52.520008, lng: 13.404954, scores: { medien: 15, zielgruppe: 22, digital: 24, wirtschaft: 20, identitaet: 23, praktikabilitaet: 18 }, score: 82, description: 'Hauptstadt mit diverser Medienlandschaft' },
                { name: 'Hamburg', bundesland: 'Hamburg', einwohner: 1906411, kaufkraft: 26741, akademikerquote: 32.1, lokalzeitungen: 6, typ: 'Medienstadt', openData: true, funke: true, ippen: false, madsack: true, lat: 53.551086, lng: 9.993682, scores: { medien: 18, zielgruppe: 21, digital: 22, wirtschaft: 23, identitaet: 22, praktikabilitaet: 20 }, score: 86, description: 'Medienmetropole mit starker Wirtschaft' },
                { name: 'M√ºnchen', bundesland: 'Bayern', einwohner: 1488202, kaufkraft: 31621, akademikerquote: 38.5, lokalzeitungen: 7, typ: 'Wirtschaftszentrum', openData: true, funke: false, ippen: true, madsack: false, lat: 48.135125, lng: 11.581981, scores: { medien: 16, zielgruppe: 23, digital: 23, wirtschaft: 25, identitaet: 21, praktikabilitaet: 19 }, score: 87, description: 'Wirtschaftsstarke Metropole mit hoher Lebensqualit√§t' },
                { name: 'K√∂ln', bundesland: 'Nordrhein-Westfalen', einwohner: 1084831, kaufkraft: 24513, akademikerquote: 29.8, lokalzeitungen: 5, typ: 'Medienstadt', openData: true, funke: true, ippen: false, madsack: false, lat: 50.937531, lng: 6.960279, scores: { medien: 17, zielgruppe: 19, digital: 21, wirtschaft: 19, identitaet: 22, praktikabilitaet: 17 }, score: 77, description: 'Medienstandort mit starker lokaler Identit√§t' },
                { name: 'Frankfurt', bundesland: 'Hessen', einwohner: 763380, kaufkraft: 28142, akademikerquote: 33.7, lokalzeitungen: 4, typ: 'Finanzmetropole', openData: true, funke: false, ippen: true, madsack: false, lat: 50.110924, lng: 8.682127, scores: { medien: 14, zielgruppe: 20, digital: 22, wirtschaft: 24, identitaet: 18, praktikabilitaet: 18 }, score: 78, description: 'Finanzzentrum mit internationaler Ausrichtung' },
                
                // Medium-sized cities
                { name: 'Dresden', bundesland: 'Sachsen', einwohner: 556227, kaufkraft: 21982, akademikerquote: 36.2, lokalzeitungen: 3, typ: 'Kulturstadt', openData: true, funke: false, ippen: false, madsack: true, lat: 51.050407, lng: 13.737262, scores: { medien: 12, zielgruppe: 18, digital: 20, wirtschaft: 17, identitaet: 21, praktikabilitaet: 16 }, score: 70, description: 'Kulturstadt mit wachsender Tech-Szene' },
                { name: 'Leipzig', bundesland: 'Sachsen', einwohner: 597493, kaufkraft: 20846, akademikerquote: 31.5, lokalzeitungen: 3, typ: 'Universit√§tsstadt', openData: true, funke: false, ippen: false, madsack: true, lat: 51.339695, lng: 12.373075, scores: { medien: 13, zielgruppe: 19, digital: 21, wirtschaft: 16, identitaet: 20, praktikabilitaet: 17 }, score: 72, description: 'Dynamische Stadt mit junger Bev√∂lkerung' },
                { name: 'Dortmund', bundesland: 'Nordrhein-Westfalen', einwohner: 587696, kaufkraft: 21738, akademikerquote: 24.3, lokalzeitungen: 3, typ: 'Ruhrgebiet', openData: true, funke: true, ippen: false, madsack: false, lat: 51.513587, lng: 7.465298, scores: { medien: 14, zielgruppe: 16, digital: 18, wirtschaft: 15, identitaet: 19, praktikabilitaet: 15 }, score: 65, description: 'Wandel vom Bergbau zur Wissensgesellschaft' },
                { name: 'Stuttgart', bundesland: 'Baden-W√ºrttemberg', einwohner: 632865, kaufkraft: 27394, akademikerquote: 34.1, lokalzeitungen: 4, typ: 'Industriestadt', openData: true, funke: false, ippen: false, madsack: false, lat: 48.775846, lng: 9.182932, scores: { medien: 15, zielgruppe: 20, digital: 21, wirtschaft: 22, identitaet: 19, praktikabilitaet: 17 }, score: 76, description: 'Automobilstandort mit hoher Innovationskraft' },
                { name: 'D√ºsseldorf', bundesland: 'Nordrhein-Westfalen', einwohner: 621877, kaufkraft: 27621, akademikerquote: 32.8, lokalzeitungen: 4, typ: 'Landeshauptstadt', openData: true, funke: true, ippen: false, madsack: false, lat: 51.227741, lng: 6.773456, scores: { medien: 16, zielgruppe: 20, digital: 20, wirtschaft: 21, identitaet: 20, praktikabilitaet: 18 }, score: 77, description: 'Kunst- und Modemetropole am Rhein' },
                
                // Smaller cities with potential
                { name: 'Heidelberg', bundesland: 'Baden-W√ºrttemberg', einwohner: 161485, kaufkraft: 25987, akademikerquote: 42.3, lokalzeitungen: 2, typ: 'Universit√§tsstadt', openData: true, funke: false, ippen: false, madsack: false, lat: 49.398752, lng: 8.672434, scores: { medien: 18, zielgruppe: 22, digital: 21, wirtschaft: 19, identitaet: 23, praktikabilitaet: 20 }, score: 83, description: 'Wissenschaftsstandort mit hoher Lebensqualit√§t' },
                { name: 'Freiburg', bundesland: 'Baden-W√ºrttemberg', einwohner: 230940, kaufkraft: 24532, akademikerquote: 38.7, lokalzeitungen: 2, typ: 'Universit√§tsstadt', openData: true, funke: false, ippen: false, madsack: false, lat: 47.999008, lng: 7.842104, scores: { medien: 17, zielgruppe: 21, digital: 20, wirtschaft: 18, identitaet: 22, praktikabilitaet: 19 }, score: 79, description: 'Gr√ºne Stadt mit hoher Innovationskraft' },
                { name: 'M√ºnster', bundesland: 'Nordrhein-Westfalen', einwohner: 316403, kaufkraft: 23876, akademikerquote: 37.1, lokalzeitungen: 2, typ: 'Universit√§tsstadt', openData: true, funke: false, ippen: false, madsack: false, lat: 51.960665, lng: 7.626135, scores: { medien: 19, zielgruppe: 21, digital: 19, wirtschaft: 17, identitaet: 23, praktikabilitaet: 21 }, score: 80, description: 'Fahrradstadt mit jungem Publikum' },
                { name: 'Augsburg', bundesland: 'Bayern', einwohner: 296478, kaufkraft: 24198, akademikerquote: 26.4, lokalzeitungen: 2, typ: 'Historische Stadt', openData: false, funke: false, ippen: false, madsack: false, lat: 48.370545, lng: 10.897789, scores: { medien: 20, zielgruppe: 17, digital: 16, wirtschaft: 18, identitaet: 20, praktikabilitaet: 18 }, score: 73, description: 'Traditionsreiche Stadt ohne Gro√üverlag' },
                { name: 'Bonn', bundesland: 'Nordrhein-Westfalen', einwohner: 329673, kaufkraft: 25432, akademikerquote: 35.8, lokalzeitungen: 2, typ: 'Bundesstadt', openData: true, funke: false, ippen: false, madsack: false, lat: 50.73743, lng: 7.098207, scores: { medien: 18, zielgruppe: 20, digital: 19, wirtschaft: 19, identitaet: 21, praktikabilitaet: 19 }, score: 78, description: 'Ehemalige Hauptstadt mit UN-Standort' },
                
                // Strategic smaller cities
                { name: 'Potsdam', bundesland: 'Brandenburg', einwohner: 183154, kaufkraft: 23654, akademikerquote: 39.2, lokalzeitungen: 2, typ: 'Landeshauptstadt', openData: true, funke: false, ippen: false, madsack: true, lat: 52.390569, lng: 13.064473, scores: { medien: 21, zielgruppe: 21, digital: 20, wirtschaft: 18, identitaet: 22, praktikabilitaet: 20 }, score: 82, description: 'Medienstandort nahe Berlin' },
                { name: 'Regensburg', bundesland: 'Bayern', einwohner: 153542, kaufkraft: 25123, akademikerquote: 31.6, lokalzeitungen: 2, typ: 'Universit√§tsstadt', openData: false, funke: false, ippen: false, madsack: false, lat: 49.013432, lng: 12.101624, scores: { medien: 22, zielgruppe: 19, digital: 17, wirtschaft: 19, identitaet: 21, praktikabilitaet: 19 }, score: 79, description: 'Historische Stadt ohne Gro√üverlag' },
                { name: 'Ulm', bundesland: 'Baden-W√ºrttemberg', einwohner: 126790, kaufkraft: 25876, akademikerquote: 33.4, lokalzeitungen: 1, typ: 'Wissenschaftsstadt', openData: true, funke: false, ippen: false, madsack: false, lat: 48.401082, lng: 9.987608, scores: { medien: 23, zielgruppe: 19, digital: 20, wirtschaft: 19, identitaet: 18, praktikabilitaet: 18 }, score: 79, description: 'Innovationsstandort ohne Gro√üverlag' },
                { name: 'Jena', bundesland: 'Th√ºringen', einwohner: 111343, kaufkraft: 21234, akademikerquote: 40.1, lokalzeitungen: 1, typ: 'Universit√§tsstadt', openData: true, funke: false, ippen: false, madsack: false, lat: 50.927054, lng: 11.586361, scores: { medien: 24, zielgruppe: 20, digital: 21, wirtschaft: 17, identitaet: 20, praktikabilitaet: 19 }, score: 81, description: 'Optik- und Hightech-Standort' },
                { name: 'Konstanz', bundesland: 'Baden-W√ºrttemberg', einwohner: 84446, kaufkraft: 24987, akademikerquote: 36.8, lokalzeitungen: 1, typ: 'Universit√§tsstadt', openData: false, funke: false, ippen: false, madsack: false, lat: 47.677788, lng: 9.173239, scores: { medien: 25, zielgruppe: 20, digital: 18, wirtschaft: 18, identitaet: 21, praktikabilitaet: 20 }, score: 82, description: 'Grenzstadt mit hohem Potenzial' }
            ];
            
            updateDisplay();
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // File upload drag and drop
            const fileUpload = document.querySelector('.file-upload');
            if (fileUpload) {
                fileUpload.addEventListener('dragover', dragOverHandler);
                fileUpload.addEventListener('dragleave', dragLeaveHandler);
                fileUpload.addEventListener('drop', dropHandler);
            }
        }
        
        // Update display
        function updateDisplay() {
            filteredCities = cities;
            updateStats();
            updateTable();
            updateFilters();
        }
        
        // Update statistics
        function updateStats() {
            document.getElementById('totalCities').textContent = cities.length;
            
            const avgScore = cities.length > 0 
                ? Math.round(cities.reduce((sum, city) => sum + city.score, 0) / cities.length)
                : 0;
            document.getElementById('avgScore').textContent = avgScore;
            
            const topCities = cities.filter(city => city.score >= 75).length;
            document.getElementById('topCities').textContent = topCities;
        }
        
        // Update table
        function updateTable() {
            const tbody = document.getElementById('citiesTableBody');
            tbody.innerHTML = '';
            
            filteredCities.forEach(city => {
                const row = `
                    <tr>
                        <td><strong>${city.name}</strong></td>
                        <td>${city.bundesland}</td>
                        <td>${city.einwohner.toLocaleString()}</td>
                        <td>${city.kaufkraft.toLocaleString()}‚Ç¨</td>
                        <td>${city.akademikerquote}%</td>
                        <td><span class="score-badge ${getScoreClass(city.score)}">${city.score}</span></td>
                        <td>
                            ${city.funke ? '<span title="Funke">F</span>' : ''}
                            ${city.ippen ? '<span title="Ippen">I</span>' : ''}
                            ${city.madsack ? '<span title="Madsack">M</span>' : ''}
                            ${!city.funke && !city.ippen && !city.madsack ? '‚Äî' : ''}
                        </td>
                        <td>
                            <button class="btn btn-primary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="showCityDetails('${city.name}')">üìã Details</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }
        
        // Update filters
        function updateFilters() {
            const bundeslaender = [...new Set(cities.map(city => city.bundesland))].sort();
            const bundeslandFilter = document.getElementById('bundeslandFilter');
            bundeslandFilter.innerHTML = '<option value="">Alle</option>';
            bundeslaender.forEach(bl => {
                bundeslandFilter.innerHTML += `<option value="${bl}">${bl}</option>`;
            });
        }
        
        // Get score class
        function getScoreClass(score) {
            if (score >= 75) return 'score-high';
            if (score >= 60) return 'score-medium';
            return 'score-low';
        }
        
        // Filter table
        function filterTable() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const bundesland = document.getElementById('bundeslandFilter').value;
            const minScore = parseInt(document.getElementById('minScoreFilter').value) || 0;
            const verlag = document.getElementById('verlagFilter').value;
            
            filteredCities = cities.filter(city => {
                let match = true;
                
                if (searchTerm && !city.name.toLowerCase().includes(searchTerm)) {
                    match = false;
                }
                
                if (bundesland && city.bundesland !== bundesland) {
                    match = false;
                }
                
                if (city.score < minScore) {
                    match = false;
                }
                
                if (verlag) {
                    if (verlag === 'none' && (city.funke || city.ippen || city.madsack)) {
                        match = false;
                    } else if (verlag === 'funke' && !city.funke) {
                        match = false;
                    } else if (verlag === 'ippen' && !city.ippen) {
                        match = false;
                    } else if (verlag === 'madsack' && !city.madsack) {
                        match = false;
                    }
                }
                
                return match;
            });
            
            updateTable();
        }
        
        // Reset filters
        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('bundeslandFilter').value = '';
            document.getElementById('minScoreFilter').value = '';
            document.getElementById('verlagFilter').value = '';
            filterTable();
        }
        
        // Sort table
        function sortTable(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'desc';
            }
            
            filteredCities.sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];
                
                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }
                
                if (sortDirection === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
            
            updateTable();
        }
        
        // Switch tabs
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            if (tabName === 'map') {
                document.getElementById('map-tab').classList.add('active');
                initMap();
            } else {
                document.getElementById(tabName).classList.add('active');
                
                if (tabName === 'segments') {
                    updateSegmentAnalysis();
                } else if (tabName === 'comparison') {
                    setupComparisonSelects();
                }
            }
            
            // Add active class to clicked nav tab
            event.target.classList.add('active');
        }
        
        // Initialize map
        function initMap() {
            if (!map) {
                map = L.map('map').setView([51.165691, 10.451526], 6);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(map);
            }
            
            // Clear existing markers
            map.eachLayer(layer => {
                if (layer instanceof L.CircleMarker) {
                    map.removeLayer(layer);
                }
            });
            
            // Add city markers
            filteredCities.forEach(city => {
                const color = city.score >= 75 ? '#10b981' : 
                            city.score >= 60 ? '#f59e0b' : '#ef4444';
                
                const marker = L.circleMarker([city.lat, city.lng], {
                    radius: Math.sqrt(city.einwohner / 10000),
                    fillColor: color,
                    color: darkMode ? '#fff' : '#000',
                    weight: 1,
                    opacity: 0.8,
                    fillOpacity: 0.6
                }).addTo(map);
                
                let verlagInfo = [];
                if (city.funke) verlagInfo.push('Funke');
                if (city.ippen) verlagInfo.push('Ippen');
                if (city.madsack) verlagInfo.push('Madsack');
                
                marker.bindPopup(`
                    <strong>${city.name}</strong><br>
                    Score: ${city.score}<br>
                    Einwohner: ${city.einwohner.toLocaleString()}<br>
                    Kaufkraft: ${city.kaufkraft.toLocaleString()}‚Ç¨<br>
                    ${verlagInfo.length ? 'Verlage: ' + verlagInfo.join(', ') : 'Keine Gro√üverlage'}
                `);
            });
            
            setTimeout(() => { map.invalidateSize(); }, 100);
        }
        
        // Update segment analysis
        function updateSegmentAnalysis() {
            const segmentGrid = document.getElementById('segmentGrid');
            
            const segments = {
                'Top St√§dte (75+)': cities.filter(c => c.score >= 75).sort((a, b) => b.score - a.score),
                'Ohne Gro√üverlage': cities.filter(c => !c.funke && !c.ippen && !c.madsack),
                'Universit√§tsst√§dte': cities.filter(c => c.typ.includes('Universit√§tsstadt')),
                'Hohe Kaufkraft (>28k)': cities.filter(c => c.kaufkraft > 28000),
                'Hohe Akademiker (>35%)': cities.filter(c => c.akademikerquote > 35),
                'Gro√üe St√§dte (>500k)': cities.filter(c => c.einwohner > 500000)
            };
            
            segmentGrid.innerHTML = '';
            for (const [title, segmentCities] of Object.entries(segments)) {
                if (segmentCities.length > 0) {
                    const card = `
                        <div class="segment-card">
                            <h3>${title} (${segmentCities.length})</h3>
                            <ul class="city-list">
                                ${segmentCities.slice(0, 5).map(c => {
                                    const scoreClass = c.score >= 75 ? 'score-high' : 
                                                      c.score >= 60 ? 'score-medium' : 'score-low';
                                    return `
                                        <li>
                                            <span>${c.name}</span>
                                            <span class="score-badge ${scoreClass}">${c.score}</span>
                                        </li>
                                    `;
                                }).join('')}
                            </ul>
                        </div>
                    `;
                    segmentGrid.innerHTML += card;
                }
            }
        }
        
        // Setup comparison selects
        function setupComparisonSelects() {
            const city1Select = document.getElementById('city1Select');
            const city2Select = document.getElementById('city2Select');
            
            if (city1Select.options.length <= 1) {
                cities.forEach(city => {
                    city1Select.innerHTML += `<option value="${city.name}">${city.name} (${city.score})</option>`;
                    city2Select.innerHTML += `<option value="${city.name}">${city.name} (${city.score})</option>`;
                });
                
                city1Select.addEventListener('change', updateComparison);
                city2Select.addEventListener('change', updateComparison);
            }
        }
        
        // Update comparison
        function updateComparison() {
            const city1Name = document.getElementById('city1Select').value;
            const city2Name = document.getElementById('city2Select').value;
            
            if (!city1Name || !city2Name) return;
            
            const city1 = cities.find(c => c.name === city1Name);
            const city2 = cities.find(c => c.name === city2Name);
            
            document.getElementById('city1Details').innerHTML = `
                <h4 style="color: var(--primary-color);">${city1.name}</h4>
                <p>Score: <strong>${city1.score}</strong></p>
                <p>Einwohner: ${city1.einwohner.toLocaleString()}</p>
                <p>Kaufkraft: ${city1.kaufkraft.toLocaleString()}‚Ç¨</p>
                <p>Akademiker: ${city1.akademikerquote}%</p>
            `;
            
            document.getElementById('city2Details').innerHTML = `
                <h4 style="color: var(--primary-color);">${city2.name}</h4>
                <p>Score: <strong>${city2.score}</strong></p>
                <p>Einwohner: ${city2.einwohner.toLocaleString()}</p>
                <p>Kaufkraft: ${city2.kaufkraft.toLocaleString()}‚Ç¨</p>
                <p>Akademiker: ${city2.akademikerquote}%</p>
            `;
            
            // Chart update
            const ctx = document.getElementById('comparisonChart').getContext('2d');
            const textColor = darkMode ? '#f3f4f6' : '#1f2937';
            const gridColor = darkMode ? '#374151' : '#e5e7eb';
            
            if (comparisonChart) comparisonChart.destroy();
            
            comparisonChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Medien', 'Zielgruppe', 'Digital', 'Wirtschaft', 'Identit√§t', 'Praktikabilit√§t'],
                    datasets: [
                        {
                            label: city1.name,
                            data: Object.values(city1.scores),
                            backgroundColor: 'rgba(37, 99, 235, 0.2)',
                            borderColor: '#2563eb',
                            borderWidth: 2
                        },
                        {
                            label: city2.name,
                            data: Object.values(city2.scores),
                            backgroundColor: 'rgba(16, 185, 129, 0.2)',
                            borderColor: '#10b981',
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: {
                                color: textColor
                            }
                        }
                    },
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 25,
                            ticks: {
                                color: textColor
                            },
                            grid: {
                                color: gridColor
                            },
                            pointLabels: {
                                color: textColor
                            }
                        }
                    }
                }
            });
        }
        
        // Show city details
        function showCityDetails(cityName) {
            const city = cities.find(c => c.name === cityName);
            const categoryLabels = {
                medien: 'Medienwettbewerb',
                zielgruppe: 'Zielgruppe',
                digital: 'Digitale Affinit√§t',
                wirtschaft: 'Wirtschaftskraft',
                identitaet: 'Lokale Identit√§t',
                praktikabilitaet: 'Praktikabilit√§t'
            };
            
            document.getElementById('modalTitle').textContent = city.name;
            document.getElementById('modalBody').innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr; gap: 1rem;">
                    <div>
                        <h3 style="color: var(--primary-color); margin-bottom: 1rem;">Basisdaten</h3>
                        <p><strong>Bundesland:</strong> ${city.bundesland}</p>
                        <p><strong>Einwohner:</strong> ${city.einwohner.toLocaleString()}</p>
                        <p><strong>Kaufkraft:</strong> ${city.kaufkraft.toLocaleString()}‚Ç¨</p>
                        <p><strong>Akademikerquote:</strong> ${city.akademikerquote}%</p>
                        <p><strong>Stadttyp:</strong> ${city.typ}</p>
                        <p><strong>Lokalzeitungen:</strong> ${city.lokalzeitungen}</p>
                        <p><strong>Open Data:</strong> ${city.openData ? 'Ja' : 'Nein'}</p>
                    </div>
                    <div>
                        <h3 style="color: var(--primary-color); margin-bottom: 1rem;">Bewertung (Gesamtscore: ${city.score})</h3>
                        ${Object.keys(city.scores).map(cat => {
                            const weight = categoryWeights[cat];
                            const contribution = Math.round((city.scores[cat] / 25) * weight);
                            return `
                                <p>
                                    <strong>${categoryLabels[cat]}:</strong> 
                                    ${city.scores[cat]}/25 
                                    <span style="color: var(--text-secondary); font-size: 0.875rem;">
                                        (Gewicht: ${weight.toFixed(1)}% ‚Üí ${contribution} Punkte)
                                    </span>
                                </p>
                            `;
                        }).join('')}
                    </div>
                    <div>
                        <h3 style="color: var(--primary-color); margin-bottom: 1rem;">Beschreibung</h3>
                        <p>${city.description}</p>
                    </div>
                </div>
            `;
            document.getElementById('cityModal').classList.add('active');
        }
        
        // Close modal
        function closeModal() {
            document.getElementById('cityModal').classList.remove('active');
        }
        
        // Data source functions
        function connectDataSource(source) {
            const statusElement = document.getElementById(`${source}-status`);
            
            if (source === 'custom') {
                document.getElementById('fileInput').click();
                return;
            }
            
            if (source === 'gfk') {
                const apiKey = prompt('Bitte GfK API-Key eingeben:');
                if (!apiKey) return;
                localStorage.setItem('gfk_api_key', apiKey);
            }
            
            statusElement.textContent = 'Verbinde...';
            statusElement.style.color = 'var(--warning-color)';
            
            // Simulate API connection
            setTimeout(() => {
                dataSources[source].active = true;
                dataSources[source].lastUpdate = new Date().toISOString();
                statusElement.textContent = 'Verbunden ‚úì';
                statusElement.style.color = 'var(--success-color)';
                
                // Add sample data if needed
                if (source === 'osm') {
                    fetchOSMData();
                } else if (source === 'mediadb') {
                    fetchMediaData();
                }
            }, 1500);
        }
        
        function toggleDataSource(key) {
            dataSources[key].active = !dataSources[key].active;
            if (dataSources[key].active) {
                dataSources[key].lastUpdate = new Date().toISOString();
                showSuccessMessage(`${dataSources[key].name} aktiviert`);
            } else {
                showSuccessMessage(`${dataSources[key].name} deaktiviert`);
            }
        }
        
        function updateAllDataSources() {
            Object.keys(dataSources).forEach(key => {
                if (dataSources[key].active) {
                    dataSources[key].lastUpdate = new Date().toISOString();
                }
            });
            showSuccessMessage('Alle aktiven Datenquellen wurden aktualisiert');
        }
        
        // Fetch additional data
        async function fetchOSMData() {
            // Simulate fetching geographical data
            console.log('Fetching OSM data...');
            // In production, this would make actual API calls
        }
        
        async function fetchMediaData() {
            // Simulate fetching media database
            console.log('Fetching media data...');
            // In production, this would connect to internal database
        }
        
        // File handling
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            const fileName = file.name.toLowerCase();
            
            if (fileName.endsWith('.csv')) {
                reader.onload = (e) => {
                    const csv = e.target.result;
                    Papa.parse(csv, {
                        header: true,
                        complete: (results) => {
                            processImportedData(results.data);
                        }
                    });
                };
                reader.readAsText(file);
            } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    processImportedData(jsonData);
                };
                reader.readAsArrayBuffer(file);
            }
        }
        
        function processImportedData(data) {
            // Process and validate imported data
            const importStatus = document.getElementById('importStatus');
            importStatus.innerHTML = `
                <div class="success-message">
                    ‚úì ${data.length} Datens√§tze erfolgreich importiert
                </div>
            `;
            
            // Merge with existing data
            // In production, this would include validation and merging logic
            console.log('Imported data:', data);
            
            dataSources.custom.active = true;
            dataSources.custom.lastUpdate = new Date().toISOString();
            document.getElementById('custom-status').textContent = 'Verbunden ‚úì';
            document.getElementById('custom-status').style.color = 'var(--success-color)';
        }
        
        // Drag and drop handlers
        function dragOverHandler(ev) {
            ev.preventDefault();
            ev.currentTarget.classList.add('dragover');
        }
        
        function dragLeaveHandler(ev) {
            ev.currentTarget.classList.remove('dragover');
        }
        
        function dropHandler(ev) {
            ev.preventDefault();
            ev.currentTarget.classList.remove('dragover');
            
            if (ev.dataTransfer.items) {
                for (let i = 0; i < ev.dataTransfer.items.length; i++) {
                    if (ev.dataTransfer.items[i].kind === 'file') {
                        const file = ev.dataTransfer.items[i].getAsFile();
                        handleFileSelect({ target: { files: [file] } });
                    }
                }
            }
        }
        
        // Export to Excel
        function exportToExcel() {
            const ws = XLSX.utils.json_to_sheet(filteredCities.map(city => ({
                Stadt: city.name,
                Bundesland: city.bundesland,
                Einwohner: city.einwohner,
                Kaufkraft: city.kaufkraft,
                'Akademiker %': city.akademikerquote,
                Score: city.score,
                Medien: city.scores.medien,
                Zielgruppe: city.scores.zielgruppe,
                Digital: city.scores.digital,
                Wirtschaft: city.scores.wirtschaft,
                Identit√§t: city.scores.identitaet,
                Praktikabilit√§t: city.scores.praktikabilitaet,
                'Funke': city.funke ? 'Ja' : 'Nein',
                'Ippen': city.ippen ? 'Ja' : 'Nein',
                'Madsack': city.madsack ? 'Ja' : 'Nein',
                'Open Data': city.openData ? 'Ja' : 'Nein'
            })));
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'St√§dte');
            XLSX.writeFile(wb, `yo-lokalmedien-analyse-${new Date().toISOString().split('T')[0]}.xlsx`);
        }
        
        // API Configuration
        function saveApiConfig() {
            const gfkKey = document.getElementById('gfkApiKey').value;
            const interval = document.getElementById('updateInterval').value;
            
            if (gfkKey) {
                localStorage.setItem('gfk_api_key', gfkKey);
            }
            localStorage.setItem('update_interval', interval);
            
            showSuccessMessage('Konfiguration gespeichert');
        }
        
        function loadDataSourceConfig() {
            const gfkKey = localStorage.getItem('gfk_api_key');
            const interval = localStorage.getItem('update_interval');
            
            if (gfkKey) {
                document.getElementById('gfkApiKey').value = gfkKey;
            }
            if (interval) {
                document.getElementById('updateInterval').value = interval;
            }
        }
        
        // Theme management
        function toggleTheme() {
            darkMode = !darkMode;
            document.body.setAttribute('data-theme', darkMode ? 'dark' : '');
            localStorage.setItem('theme', darkMode ? 'dark' : 'light');
            document.querySelector('.theme-toggle').textContent = darkMode ? '‚òÄÔ∏è' : 'üåô';
            
            // Update chart if exists
            if (comparisonChart) {
                updateComparison();
            }
        }
        
        function checkStoredTheme() {
            const storedTheme = localStorage.getItem('theme');
            if (storedTheme === 'dark') {
                darkMode = true;
                document.body.setAttribute('data-theme', 'dark');
                document.querySelector('.theme-toggle').textContent = '‚òÄÔ∏è';
            }
        }
        
        // Helper functions
        function showSuccessMessage(message) {
            const alert = document.createElement('div');
            alert.className = 'success-message';
            alert.textContent = message;
            alert.style.position = 'fixed';
            alert.style.top = '20px';
            alert.style.right = '20px';
            alert.style.zIndex = '2000';
            document.body.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 3000);
        }
        
        function showErrorMessage(message) {
            const alert = document.createElement('div');
            alert.className = 'error-message';
            alert.textContent = message;
            alert.style.position = 'fixed';
            alert.style.top = '20px';
            alert.style.right = '20px';
            alert.style.zIndex = '2000';
            document.body.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 3000);
        }
        
        // Methodology Modal Functions
        function showMethodologyModal() {
            document.getElementById('methodologyModal').classList.add('active');
            // Default to explanation tab
            switchModalTab('explanation');
            loadCurrentWeights();
        }
        
        function closeMethodologyModal() {
            document.getElementById('methodologyModal').classList.remove('active');
        }
        
        function switchModalTab(tabName) {
            // Hide all tab contents
            document.getElementById('explanation-content').style.display = 'none';
            document.getElementById('weights-content').style.display = 'none';
            
            // Remove active class from all tabs
            document.getElementById('tab-explanation').classList.remove('active');
            document.getElementById('tab-weights').classList.remove('active');
            
            // Show selected tab and mark as active
            if (tabName === 'explanation') {
                document.getElementById('explanation-content').style.display = 'block';
                document.getElementById('tab-explanation').classList.add('active');
            } else if (tabName === 'weights') {
                document.getElementById('weights-content').style.display = 'block';
                document.getElementById('tab-weights').classList.add('active');
                loadCurrentWeights();
            }
        }
        
        function loadCurrentWeights() {
            const categories = ['medien', 'zielgruppe', 'digital', 'wirtschaft', 'identitaet', 'praktikabilitaet'];
            
            categories.forEach(cat => {
                const slider = document.getElementById(`weight-${cat}`);
                const value = document.getElementById(`weight-${cat}-value`);
                if (slider && value) {
                    slider.value = categoryWeights[cat];
                    value.textContent = `${categoryWeights[cat].toFixed(1)}%`;
                }
            });
            
            updateTotalWeight();
        }
        
        function updateWeights() {
            const categories = ['medien', 'zielgruppe', 'digital', 'wirtschaft', 'identitaet', 'praktikabilitaet'];
            
            categories.forEach(cat => {
                const slider = document.getElementById(`weight-${cat}`);
                const value = document.getElementById(`weight-${cat}-value`);
                if (slider && value) {
                    const weight = parseFloat(slider.value);
                    value.textContent = `${weight.toFixed(1)}%`;
                }
            });
            
            updateTotalWeight();
        }
        
        function updateTotalWeight() {
            const categories = ['medien', 'zielgruppe', 'digital', 'wirtschaft', 'identitaet', 'praktikabilitaet'];
            let total = 0;
            
            categories.forEach(cat => {
                const slider = document.getElementById(`weight-${cat}`);
                if (slider) {
                    total += parseFloat(slider.value);
                }
            });
            
            const totalElement = document.getElementById('total-weight');
            if (totalElement) {
                totalElement.textContent = `${total.toFixed(1)}%`;
                totalElement.style.color = Math.abs(total - 100) < 0.1 ? 'var(--success-color)' : 'var(--warning-color)';
            }
        }
        
        function resetWeights() {
            const categories = ['medien', 'zielgruppe', 'digital', 'wirtschaft', 'identitaet', 'praktikabilitaet'];
            
            categories.forEach(cat => {
                categoryWeights[cat] = 16.7;
                const slider = document.getElementById(`weight-${cat}`);
                const value = document.getElementById(`weight-${cat}-value`);
                if (slider && value) {
                    slider.value = 16.7;
                    value.textContent = '16.7%';
                }
            });
            
            updateTotalWeight();
            showSuccessMessage('Gewichtungen zur√ºckgesetzt');
        }
        
        function applyWeights() {
            const categories = ['medien', 'zielgruppe', 'digital', 'wirtschaft', 'identitaet', 'praktikabilitaet'];
            let total = 0;
            
            // Get new weights
            categories.forEach(cat => {
                const slider = document.getElementById(`weight-${cat}`);
                if (slider) {
                    categoryWeights[cat] = parseFloat(slider.value);
                    total += categoryWeights[cat];
                }
            });
            
            // Normalize to 100%
            if (total > 0) {
                categories.forEach(cat => {
                    categoryWeights[cat] = (categoryWeights[cat] / total) * 100;
                });
            }
            
            // Recalculate all city scores
            recalculateScores();
            
            // Update display
            updateDisplay();
            
            // Save to localStorage
            localStorage.setItem('categoryWeights', JSON.stringify(categoryWeights));
            
            closeMethodologyModal();
            showSuccessMessage('Neue Gewichtungen angewendet');
        }
        
        function recalculateScores() {
            cities.forEach(city => {
                let weightedScore = 0;
                let totalWeight = 0;
                
                Object.keys(categoryWeights).forEach(cat => {
                    const weight = categoryWeights[cat] / 100;
                    weightedScore += city.scores[cat] * weight * 4; // *4 because each category max is 25
                    totalWeight += weight;
                });
                
                // Normalize to 0-100 scale
                city.score = Math.round(weightedScore);
            });
            
            // Re-sort by score
            cities.sort((a, b) => b.score - a.score);
            filteredCities = cities;
        }
        
        function loadPreset(presetName) {
            const preset = weightPresets[presetName];
            if (!preset) return;
            
            const categories = Object.keys(preset);
            
            categories.forEach(cat => {
                categoryWeights[cat] = preset[cat];
                const slider = document.getElementById(`weight-${cat}`);
                const value = document.getElementById(`weight-${cat}-value`);
                if (slider && value) {
                    slider.value = preset[cat];
                    value.textContent = `${preset[cat].toFixed(1)}%`;
                }
            });
            
            updateTotalWeight();
            showSuccessMessage(`Vorlage "${presetName.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())}" geladen`);
        }
        
        function saveWeightPreset() {
            const name = prompt('Name f√ºr die Gewichtungsvorlage:');
            if (!name) return;
            
            const categories = ['medien', 'zielgruppe', 'digital', 'wirtschaft', 'identitaet', 'praktikabilitaet'];
            const preset = {};
            
            categories.forEach(cat => {
                const slider = document.getElementById(`weight-${cat}`);
                if (slider) {
                    preset[cat] = parseFloat(slider.value);
                }
            });
            
            // Save to localStorage
            let customPresets = JSON.parse(localStorage.getItem('customWeightPresets') || '{}');
            customPresets[name] = preset;
            localStorage.setItem('customWeightPresets', JSON.stringify(customPresets));
            
            // Add button to presets
            const presetsDiv = document.getElementById('weightPresets');
            if (presetsDiv) {
                const button = document.createElement('button');
                button.className = 'btn btn-secondary';
                button.textContent = name;
                button.onclick = () => loadCustomPreset(name);
                presetsDiv.appendChild(button);
            }
            
            showSuccessMessage(`Vorlage "${name}" gespeichert`);
        }
        
        function loadCustomPreset(name) {
            const customPresets = JSON.parse(localStorage.getItem('customWeightPresets') || '{}');
            const preset = customPresets[name];
            if (!preset) return;
            
            Object.keys(preset).forEach(cat => {
                categoryWeights[cat] = preset[cat];
                const slider = document.getElementById(`weight-${cat}`);
                const value = document.getElementById(`weight-${cat}-value`);
                if (slider && value) {
                    slider.value = preset[cat];
                    value.textContent = `${preset[cat].toFixed(1)}%`;
                }
            });
            
            updateTotalWeight();
            showSuccessMessage(`Vorlage "${name}" geladen`);
        }
        
        // Load saved weights on startup
        function loadSavedWeights() {
            const savedWeights = localStorage.getItem('categoryWeights');
            if (savedWeights) {
                categoryWeights = JSON.parse(savedWeights);
                recalculateScores();
            }
            
            // Load custom presets
            const customPresets = JSON.parse(localStorage.getItem('customWeightPresets') || '{}');
            const presetsDiv = document.getElementById('weightPresets');
            if (presetsDiv) {
                Object.keys(customPresets).forEach(name => {
                    const button = document.createElement('button');
                    button.className = 'btn btn-secondary';
                    button.textContent = name;
                    button.onclick = () => loadCustomPreset(name);
                    presetsDiv.appendChild(button);
                });
            }
        }
    </script>
</body>
</html>